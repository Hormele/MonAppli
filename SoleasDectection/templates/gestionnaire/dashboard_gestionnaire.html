{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1 class="mb-3">Centre de contrôle du gestionnaire de risque</h1>
<p class="lead">Consultez les suspects détectés, appliquez des règles métier, et exportez les rapports de fraude.</p>

<hr>

<!-- Section Suspects -->
<h2>Suspects détectés</h2>
<table class="table table-bordered table-striped mt-3">
  <thead>
    <tr>
      <th>Email</th>
      <th>Motif</th>
      <th>Décision</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for suspect in suspects %}
    <tr>
      <td>{{ suspect.email }}</td>
      <td>{{ suspect.description }}</td>
      <td>{{ suspect.get_decision_display }}</td>
      <td>
        <a href="{% url 'prendre_decision_suspect' suspect.id 'bloque' %}" class="btn btn-danger btn-sm">Bloquer</a>
        <a href="{% url 'prendre_decision_suspect' suspect.id 'legitime' %}" class="btn btn-success btn-sm">Légitime</a>
        <a href="{% url 'prendre_decision_suspect' suspect.id 'en_attente' %}" class="btn btn-secondary btn-sm">En attente</a>
        <a href="{% url 'gestionnaire_rapport_detail' suspect.id %}" class="btn btn-info btn-sm">Voir détail</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<hr>

<!-- Section Règles métier -->
<h2>Règles métier</h2>
<a href="{% url 'ajouter_regle_metier' %}" class="btn btn-primary mb-3">+ Ajouter une règle</a>
<table class="table table-bordered table-hover">
  <thead class="thead-light">
    <tr>
      <th>Nom</th>
      <th>Condition</th>
      <th>Statut</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for regle in regles %}
    <tr>
      <td>{{ regle.nom }}</td>
      <td>{{ regle.condition }}</td>
      <td>
        {% if regle.actif %}
          <span class="badge badge-success">Active</span>
        {% else %}
          <span class="badge badge-danger">Inactive</span>
        {% endif %}
      </td>
      <td>
        <a href="{% url 'modifier_regle_metier' regle.id %}" class="btn btn-sm btn-warning">Modifier</a>
        <a href="{% url 'supprimer_regle_metier' regle.id %}" class="btn btn-sm btn-danger">Supprimer</a>
        <a href="{% url 'toggle_regle_metier' regle.id %}" class="btn btn-sm btn-secondary">
          {% if regle.actif %}Désactiver{% else %}Activer{% endif %}
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<hr>

<!-- Rapport PDF -->
<h2>Rapport de fraude</h2>
<p>Exporter le dernier rapport généré :</p>
<a href="{% url 'exporter_rapport_pdf' campagne_id %}" class="btn btn-dark mb-4">Télécharger le rapport PDF</a>

<hr>

<!-- Graphique -->
<h2>Répartition des décisions</h2>
<canvas id="decisionChart" width="600" height="300"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('decisionChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Bloqué', 'Légitime', 'En attente'],
      datasets: [{
        label: 'Décisions',
        data: {{ decision_data|safe }},
        backgroundColor: ['#dc3545', '#28a745', '#6c757d']
      }]
    }
  });
</script>
{% endblock %}